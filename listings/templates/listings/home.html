<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>iRent ProSpace â€“ Find Your Dream Home</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  {% load static %}
  <link rel="stylesheet" href="{% static 'listings/style.css' %}">
  <!-- Add this in your <head> to load fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Montserrat:wght@600;700&display=swap" rel="stylesheet">


<style>
  /* ================= HERO & LAYOUT ================= */
.hero { 
    background: #fff; 
    padding: 3rem 0 2rem; 
}

.search-bar { 
    background: #fff; 
    border: 1px solid #e6e6e6; 
    border-radius: 12px; 
    padding: 1.25rem; 
    box-shadow: 0 4px 16px rgba(0,0,0,.04); 
    min-height: 100vh; 
}

.results-scroll { 
    min-height: 100vh; 
}

/* ================= FORM ELEMENTS ================= */
.form-control,
.form-select {
    font-size: 1.1rem;
    padding: 0.75rem 1rem;
    height: auto; /* let padding decide height */
}

/* ================= FILTER LABELS ================= */
.filter-label {
    font-size: 1.25rem;
    font-weight: 500;
    margin-top: 1rem;
    display: inline-block;
}

/* ================= PILLS & CHIPS ================= */
.price-pill,
.chip {
    font-size: 1rem;
    padding: 0.8rem 1.6rem;
    border-radius: 30px;
    margin: 0.4rem 0.3rem;
    display: inline-flex;
    align-items: center;
    border: 1px solid #d0d0d0;
    cursor: pointer;
    transition: transform .2s ease, background .2s ease, color .2s ease, border .2s ease;
}

/* Hover & active states */
.price-pill:hover,
.chip:hover,
.price-pill.active,
.chip.active {
    transform: scale(1.08);
}

/* Active selected style */
.price-pill.active,
.chip.active {
    border: 2px solid #000 !important;
    background: transparent !important;
    color: #000 !important;
}

/* ================= BUTTONS ================= */
/* Base hover animation */
.hover-btn {
    transition: transform .2s ease, background .2s ease, color .2s ease, border .2s ease;
    border: 2px solid transparent;
    cursor: pointer;
}

/* Generic hover effect */
.hover-btn:hover {
    transform: scale(1.05);
}

/* Accent button (black bg / white text) */
.btn-accent.hover-btn {
    background-color: #000;
    color: #fff;
    border-color: #000;
    font-weight: 500;
}

.btn-accent.hover-btn:hover {
    background-color: #fff !important;
    color: #000 !important;
    border-color: #000 !important;
}

/* Outline dark button (white bg / black text / black border) */
.btn-outline-dark.hover-btn {
    background-color: transparent;
    color: #000;
    border-color: #000;
    font-weight: 500;
}

.btn-outline-dark.hover-btn:hover {
    background-color: #000 !important;
    color: #fff !important;
    border-color: #000 !important;
}

/* Hero / large buttons */
.btn-lg.hover-btn {
    font-size: 1.2rem;
    padding: 0.8rem 1.5rem;
}

/* ================= NAV-LINKS ================= */
.nav-link.hover-btn {
    border-radius: 8px;
    padding: 0.5rem 1rem;
}

.nav-link.hover-btn:hover {
    background-color: rgba(0,0,0,0.05);
    color: #000 !important;
}
/* ================= SIGN UP / LOG IN BUTTONS ================= */
.btn-signup,
.btn-login {
    font-family: 'Poppins', 'Montserrat', sans-serif;
    font-size: 1.25rem;       /* was 1.6rem â€” reduced */
    padding: 0.9rem 2.2rem;   /* was 1.2rem 3rem â€” reduced */
    border-radius: 32px;      /* slightly smaller */
    font-weight: 700;
    transition: transform .2s ease, background .2s ease, color .2s ease, border .2s ease;
    cursor: pointer;
}

/* Hover effects */
.btn-signup:hover,
.btn-login:hover {
    transform: scale(1.08);   /* slightly reduced from 1.12 */
}

/* Sign Up - solid black */
.btn-signup {
    background-color: #000;
    color: #fff;
    border: 2px solid #000;
}

.btn-signup:hover {
    background-color: #fff !important;
    color: #000 !important;
}

/* Log In - outlined */
.btn-login {
    background-color: transparent;
    color: #000;
    border: 2px solid #000;
}

.btn-login:hover {
    background-color: #000 !important;
    color: #fff !important;
}


</style>
</head>
<body>
<!-- MINIMAL HEADER -->
<!-- ===== PROFESSIONAL NAVBAR v2 ===== -->
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm py-3 sticky-top">
  <div class="container">
    <!-- BRAND -->
    <a class="navbar-brand fw-bold text-dark fs-4" href="{% url 'home' %}">iRent ProSpace</a>
    {% if user.is_authenticated %}
      <span class="ms-3 fw-medium text-muted d-none d-lg-inline">Hi, {{ user.username }}!</span>
    {% endif %}

    <!-- MOBILE TOGGLE -->
    <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMenu">
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- NAV LINKS -->
    <div class="collapse navbar-collapse justify-content-end" id="navbarMenu">
      <ul class="navbar-nav align-items-center gap-2 gap-lg-3">
        <li class="nav-item">
          <a class="nav-link text-dark hover-btn px-3 py-2" href="{% url 'about' %}">About</a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark hover-btn px-3 py-2" href="{% url 'contact' %}">Contact Us</a>
        </li>

        {% if user.is_authenticated %}
          {% if user.profile.user_type == 'landlord' %}
            <li class="nav-item">
              <a class="btn btn-outline-dark btn-sm hover-btn" href="{% url 'my_properties' %}">My Properties</a>
            </li>
            <li class="nav-item">
              <a class="btn btn-accent btn-sm hover-btn" href="{% url 'landlord_upload' %}">Add Property</a>
            </li>
          {% endif %}
          <li class="nav-item">
            <a class="btn btn-outline-dark btn-sm hover-btn" href="{% url 'logout' %}">Logout</a>
          </li>
        {% else %}
          <li class="nav-item">
            <a class="btn-signup" href="{% url 'signup' %}">Sign Up</a>
          </li>
          <li class="nav-item">
            <a class="btn-login" href="{% url 'user_login' %}">Log In</a>

          </li>
        {% endif %}
      </ul>
    </div>
  </div>
</nav>

<!-- ===== NAVBAR STYLES & ANIMATIONS ===== -->
<style>
  /* Button & link hover effect */
  .hover-btn {
    transition: all 0.25s ease;
    border: 2px solid transparent;
  }
/* Safe hover for nav links (not buttons) */
.nav-link.hover-btn:hover {
    background-color: rgba(0,0,0,0.06) !important;
    color: #000 !important;
    border-color: transparent !important;
    transform: scale(1.05);
}


  /* Accent button */
  .btn-accent {
    background-color: #000;
    color: #fff;
    border: 2px solid #000;
    font-weight: 500;
  }

  .btn-accent:hover {
    background-color: #fff !important;
    color: #000 !important;
  }

  /* Outline dark button */
  .btn-outline-dark {
    border: 2px solid #000;
    color: #000;
    font-weight: 500;
    background-color: transparent;
  }

  .btn-outline-dark:hover {
    background-color: #000 !important;
    color: #fff !important;
  }

  /* Nav-link hover */
  .nav-link.hover-btn {
    border-radius: 8px;
  }

  /* Sticky + shadow effect */
  .navbar.sticky-top {
    backdrop-filter: blur(8px);
    z-index: 1030;
  }

  /* Mobile spacing tweaks */
  @media (max-width: 992px) {
    .navbar-nav {
      gap: 0.5rem;
    }
  }
</style>

<!-- HERO (tenants / anonymous only) -->
{% if not is_landlord %}
<!-- Google Inter font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<section class="hero" style="font-family: 'Inter', sans-serif; padding-top: 4rem;">
  <div class="container text-center">

    <!-- Exact screenshot headline -->
    
<!-- 7 rem lighter exact-screenshot headline -->
<h2 style="margin: 0; font-size: 7rem; font-weight: 400; letter-spacing: -0.04em; line-height: 1;">Find Your Perfect</h2>
<h2 style="margin: 0; font-size: 7rem; font-weight: 400; letter-spacing: -0.04em; line-height: 1;">Rental-Where</h2>
<h2 style="margin: 0 0 0.5rem 0; font-size: 7rem; font-weight: 300; letter-spacing: -0.04em; line-height: 1;">Dreams Meet Reality</h2>

 <div style="height: 1.2rem; background: transparent;"></div>

    <!-- Smooth separator line -->
    <hr class="mb-4" style="width: 80px; margin: 0 auto; border-top: 2px solid #e5e5e5;">

    <!-- Big â€œFind what fits youâ€ -->
    <h1 class="fw-700 mb-5" style="font-size: 4rem; letter-spacing: -1px;">Find what fits you</h1>

      <!-- STACKED HOVER-ZOOM BUTTONS -->
    <div class="d-flex flex-column align-items-center gap-3 mb-5">
      <a href="?show=all#results"
         class="btn btn-outline-dark btn-lg px-4 hover-btn">
        See all available rentals
      </a>
      <button class="btn btn-accent btn-lg px-4 hover-btn"
              onclick="document.getElementById('filters').scrollIntoView({behavior:'smooth', block:'start'})">
        Pick what fits you
      </button>
    </div>

 <form method="get" id="filters" class="search-bar" style="padding: 12vh 2rem; min-height: 100vh;">
  <!-- Row 1: Location + Bedrooms + Price -->
  <div class="row g-3 mb-4 justify-content-center">
    <div class="col-md-3">
      <input id="location-input"
             class="form-control form-control-sm"
             type="text"
             name="location"
             placeholder="Search by location"
             value="{{ request.GET.location }}"
             autocomplete="off"
             spellcheck="false" required>
    </div>
    <div class="col-md-2">
      <select class="form-select form-select-sm" name="bedrooms" required >
        {% for val, label in bedroom_choices %}
          <option value="{{ val }}" {% if request.GET.bedrooms == val %}selected{% elif not request.GET.bedrooms and val == 'Single Room' %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <input class="form-control form-control-sm" type="number" name="price" placeholder="Price (KES)" min="0" value="{{ request.GET.price }}" required >
    </div>
  </div>

  <!-- Row 2: Price Pills -->
  <div class="mb-3 d-flex flex-wrap justify-content-center">
    <small class="text-muted filter-label">Filter by budget:</small>
    <span class="price-pill" data-val="1-5k">KES 1 â€“ 5 k</span>
    <span class="price-pill" data-val="5-10k">KES 5 â€“ 10 k</span>
    <span class="price-pill" data-val="10-20k">KES 10 â€“ 20 k</span>
    <span class="price-pill" data-val="20k+">KES 20 k+</span>
  </div>

  <!-- Row 3: Bedroom Chips -->
  <div class="mb-4 d-flex flex-wrap justify-content-center">
    <small class="text-muted filter-label">Preferred bedrooms:</small>
     {% for val, label in bedroom_choices %}
        <span class="chip" data-bed="{{ val }}">{{ label }}</span>
     {% endfor %}
  </div>

  <!-- Row 4: Full-width Search Button + helper text -->
  <div class="d-flex flex-column justify-content-between" style="min-height: 18vh;">
    <div></div>
    <div class="d-flex justify-content-center">
      <button type="submit" class="btn btn-accent px-5"
              style="width: 60%; max-width: 600px; padding: 0.8rem 1rem; font-size: 1.2rem;">
        Search
      </button>
    </div>
    <div class="text-center mt-3">
      {% if mode %}
        <span class="search-helper text-muted small">
          {% if mode == 'exact' %}
            Exact matches found
          {% elif mode == 'near' %}
            No exact match; showing near matches
          {% elif mode == 'location' %}
            No exact match; showing location matches
          {% else %}
            No matches found
          {% endif %}
        </span>
      {% endif %}
    </div>
  </div>
</form>


    <!-- Separator Title -->
    <h4 class="fw-600 mt-5 mb-4">Available Rentals</h4>
  </div>
</section>

<!-- Auto-scroll to results after Search -->
<script>
function scrollToResults() {
  setTimeout(() => {
    document.querySelector('.results-scroll').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 150);
}
</script>
{% endif %}

{% if search_location or search_bedrooms or search_price %}
  {% if mode == 'near' %}
    <div class="alert alert-warning alert-dismissible fade show text-center fw-600 fs-5 mb-4" role="alert">
      No exact <strong>{{ search_bedrooms }}</strong> rentals in <strong>{{ search_location }}</strong> around KES {{ search_price }}.
      <br><small class="fs-6">Showing similar rooms in the same location.</small>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  {% elif mode == 'location' %}
    <div class="alert alert-warning alert-dismissible fade show text-center fw-600 fs-5 mb-4" role="alert">
      No <strong>{{ search_bedrooms }}</strong> rentals in <strong>{{ search_location }}</strong>.
      <br><small class="fs-6">Showing other available units in that area.</small>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  {% elif mode == 'none' %}
    <div class="alert alert-danger alert-dismissible fade show text-center fw-600 fs-5 mb-4" role="alert">
      No rentals found in <strong>{{ search_location }}</strong>.
      <br>
      <a href="?show=all#results" class="alert-link">Browse all listings</a>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  {% endif %}
{% endif %}

<!-- AI close-match helper -->
<div class="alert alert-info border-0 text-dark fw-500 fs-5 mb-4">
  <div class="d-flex align-items-center mb-2"><span class="me-2">ðŸ¤–</span><strong>No exact match for your filters?</strong></div>
  <p class="mb-1">
    {% if mode == 'near' %}
      I couldnâ€™t find a <strong>{{ search_bedrooms }}</strong> in <strong>{{ search_location }}</strong> around <strong>KES {{ search_price }}</strong>.
      Here are similar rooms in the same area.
    {% elif mode == 'location' %}
      No <strong>{{ search_bedrooms }}</strong> rentals in <strong>{{ search_location }}</strong> right now.
      Showing other available units in that location â€“ same area, different rooms or price.
    {% elif mode == 'none' %}
      Zero listings in <strong>{{ search_location }}</strong> at the moment.
      Broadening search to nearby places or all bedrooms â€“ scroll to see whatâ€™s close.
    {% endif %}
  </p>
  <small class="text-muted">Tip: clear filters or adjust price/rooms to see more options.</small>
</div>

<!-- AI price-band mismatch (always show if searched & price off) -->
{% if search_location and search_price %}
  {% with price_val=search_price|add:0 %}
    {% if price_val < 1000 or price_val > 20000 or price_val == 5049 %}
      <div class="alert alert-warning border-0 text-dark fw-500 fs-5 mb-4">
        <div class="d-flex align-items-center mb-2">
          <span class="me-2">ðŸ¤–</span>
          <strong>Price out of common bands?</strong>
        </div>
        <p class="mb-1">
          You entered <strong>KES {{ search_price }}</strong> â€“ no exact match in our bands.
          Showing all rentals in <strong>{{ search_location }}</strong> instead; pick a band above for tighter results.
        </p>
        <small class="text-muted">Tip: use the price pills for instant filtering.</small>
      </div>
    {% endif %}
  {% endwith %}
{% endif %}



<!-- RESULTS (always shown) -->
<section id="results" class="results-scroll py-5">
  <div class="container">
    <!-- Header for available rentals -->
    <h2 class="mb-4 fw-600 text-center">Available Rentals</h2>

    <div class="row g-4" id="results-row">
      {% for prop in properties %}
        <div class="col-md-4">
          <div class="card h-100 shadow-sm">
            {% if prop.images.first %}
              <img src="{{ prop.images.first.image.url }}" class="card-img-top" alt="{{ prop.title }}">
            {% else %}
              <div class="bg-light text-center py-5 text-muted">No Image</div>
            {% endif %}
            <div class="card-body">
              <h6 class="card-title fw-600">{{ prop.title }}</h6>
              <p class="card-text text-muted small mb-2">
                {{ prop.location }} â€¢ KES {{ prop.price }} â€¢ {{ prop.bedrooms }}
              </p>
              <a href="{% url 'property_detail' prop.id %}" class="btn btn-sm btn-accent">View Details</a>
            </div>
          </div>
        </div>
      {% empty %}
        <div class="col-12 text-center py-5">
          <p class="text-muted">No properties match your filters â€” scroll for more or adjust search.</p>
        </div>
      {% endfor %}
    </div>
  </div>
</section>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ====================== Smart Suggestions ====================== */
function generateSmartSuggestions(location, bedrooms, price) {
  if (!location && !bedrooms && !price) return [];

  const pr = Number(price) || 0;
  const band = pr >= 20001 ? '20k+' : pr >= 10001 ? '10-20k' : pr >= 5001 ? '5-10k' : pr >= 1000 ? '1-5k' : 'any';
  const suggestions = [];

  if (location) suggestions.push({ txt: `All rooms in ${location}`, url: `?location=${encodeURIComponent(location)}&show=all#results` });
  if (bedrooms) suggestions.push({ txt: `Any ${bedrooms} rental`, url: `?bedrooms=${encodeURIComponent(bedrooms)}&show=all#results` });

  const nextBand = band === '1-5k' ? '5-10k' : band === '5-10k' ? '10-20k' : band === '10-20k' ? '20k+' : '';
  if (location && bedrooms && nextBand) {
    suggestions.push({ txt: `${bedrooms} in ${location} (KES ${nextBand})`, 
      url: `?location=${encodeURIComponent(location)}&bedrooms=${encodeURIComponent(bedrooms)}&price_range=${nextBand}#results` 
    });
  }

  return suggestions;
}

function updateSmartAI(location, bedrooms, price) {
  const container = document.getElementById('smart-ai');
  const textEl = document.getElementById('smart-ai-text');
  const buttonsEl = document.getElementById('smart-ai-buttons');
  const suggestions = generateSmartSuggestions(location, bedrooms, price);

  if (suggestions.length === 0) {
    container.style.display = 'none';
    return;
  }

  textEl.textContent = 'Tight criteria! Loosen one filter for more choices:';
  buttonsEl.innerHTML = '';
  suggestions.forEach(s => {
    const btn = document.createElement('a');
    btn.href = s.url;
    btn.className = 'btn btn-sm btn-outline-primary';
    btn.textContent = s.txt;
    buttonsEl.appendChild(btn);
  });

  container.style.display = 'block';
}

/* ====================== Pills / Chips ====================== */
document.querySelectorAll('.price-pill').forEach(pill => {
  pill.addEventListener('click', () => {
    document.querySelectorAll('.price-pill').forEach(p => p.classList.remove('active'));
    pill.classList.add('active');
    const val = pill.dataset.val;
    document.querySelector('input[name="price"]').value =
      val === '1-5k' ? '5000' :
      val === '5-10k' ? '10000' :
      val === '10-20k' ? '20000' :
      val === '20k+' ? '25000' : '';
  });
});

document.querySelectorAll('.chip').forEach(chip => {
  chip.addEventListener('click', () => {
    document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
    chip.classList.add('active');
    document.querySelector('select[name="bedrooms"]').value = chip.dataset.bed;
  });
});

const priceInput = document.querySelector('input[name="price"]');
priceInput?.addEventListener('input', () => {
  const val = Number(priceInput.value) || 0;
  document.querySelectorAll('.price-pill').forEach(p => p.classList.remove('active'));
  let target = '';
  if (val >= 1000 && val <= 5000) target = '1-5k';
  if (val >= 5001 && val <= 10000) target = '5-10k';
  if (val >= 10001 && val <= 20000) target = '10-20k';
  if (val >= 20001) target = '20k+';
  document.querySelector(`.price-pill[data-val="${target}"]`)?.classList.add('active');
});

const bedSelect = document.querySelector('select[name="bedrooms"]');
bedSelect?.addEventListener('change', () => {
  document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
  document.querySelector(`.chip[data-bed="${bedSelect.value}"]`)?.classList.add('active');
});

/* ====================== AJAX Search ====================== */
document.querySelector('#filters').addEventListener('submit', async e => {
  e.preventDefault();
  const form = e.target;
  const loc = form.location.value.trim();
  const bed = form.bedrooms.value;
  const pr = form.price.value;

  if (!loc || !bed || !pr) {
    alert('Please fill Location, Bedrooms and Price.');
    return;
  }

  const url = new URL(window.location);
  const params = new URLSearchParams(new FormData(form));
  for (const [k,v] of params) url.searchParams.set(k,v);
  window.history.replaceState({}, '', url);

  try {
    const res = await fetch(url.href);
    const html = await res.text();
    const newDoc = new DOMParser().parseFromString(html, 'text/html');

    // Replace results and smart AI
    const newResults = newDoc.querySelector('#results');
    document.querySelector('#results').replaceWith(newResults);

    const newSmartAI = newDoc.querySelector('#smart-ai');
    if (newSmartAI) document.querySelector('#smart-ai').replaceWith(newSmartAI);

    // Fire scroll and suggestion update
    document.getElementById('results').scrollIntoView({behavior:'smooth', block:'start'});
  } catch(err) {
    console.error('Search failed', err);
    alert('Search failed. Please try again.');
  }
});

/* ====================== Fire initial events ====================== */
priceInput?.dispatchEvent(new Event('input'));
bedSelect?.dispatchEvent(new Event('change'));
updateSmartAI(priceInput?.value ? document.getElementById('location-input').value : '', 
              bedSelect?.value, priceInput?.value);

</script>
</body>
</html>
